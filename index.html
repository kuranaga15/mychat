<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>My Chat</title>

<style>
html { height: 100%; }

body {
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
  margin: 0;
  display: flex;
  flex-direction: column;
  min-height: 100dvh;
  background: #f2f2f2;
  color: black;
  transition: 0.3s;
}

.gray {
  color: #888;
}

body.dark .gray {
  color: #aaa;
}

body.dark {
  background: #1e1e1e;
  color: white;
}

.header {
  padding: 10px;
  background: white;
  border-bottom: 1px solid #ddd;
  display: flex;
  gap: 8px;
}

body.dark .header {
  background: #2a2a2a;
  border-color: #444;
}

.chat {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
}

.message {
  margin: 15px 0;
  display: flex;
}

.me { justify-content: flex-end; }
.other { justify-content: flex-start; }

.bubble {
  padding: 10px 14px 6px 14px;
  border-radius: 16px;
  max-width: 70%;
  word-wrap: break-word;
  display: flex;
  flex-direction: column;
}

.me .bubble { background: #cfe9ff; }
.other .bubble { background: white; }

body.dark .me .bubble { background: #2f6ea3; }
body.dark .other .bubble { background: #333; }

.text-content {
  margin-bottom: 6px;
}

.action-row {
  font-size: 11px;
  color: #888;
  display: flex;
  gap: 10px;
}

.action-row span {
  cursor: pointer;
}

body.dark .action-row {
  color: #aaa;
}

.input-area {
  display: flex;
  padding: 10px;
  background: white;
  border-top: 1px solid #ddd;
  gap: 8px;
}

body.dark .input-area {
  background: #2a2a2a;
  border-color: #444;
}

input, textarea {
  flex: 1;
  padding: 10px;
  border-radius: 20px;
  border: 1px solid #ccc;
  font-size: 16px;
  resize: none;
}

.edit-input {
  width: 100%;
  min-height: 100px;
  resize: none;
  font-size: 16px;
  border-radius: 10px;
  border: 1px solid #aaa;
  padding: 8px;
}

button {
  padding: 8px 14px;
  border: none;
  border-radius: 20px;
  cursor: pointer;
}

#sendBtn { background: #4da3ff; color: white; }
#toggleBtn { background: #eee; }
</style>
</head>

<body>

<div class="header">
  <select id="conversationSelect" onchange="switchConversation()"></select>
  <button onclick="createConversation()">ÔºãÊñ∞„Åó„ÅÑ‰ºöË©±</button>
  <button onclick="toggleDarkMode()">üåô</button>
</div>

<div class="chat" id="chat"></div>

<div class="input-area">
  <textarea id="textInput" placeholder="„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ" rows="2"></textarea>
  <button id="sendBtn" onclick="sendMessage()">ÈÄÅ‰ø°</button>
  <button id="toggleBtn" onclick="toggleSender()">Ëá™ÂàÜ</button>
</div>

<script>
let store = JSON.parse(localStorage.getItem("chatStore")) || {
  conversations: { "default": [] },
  current: "default",
  dark: false
};

let currentSender = "me";

const chat = document.getElementById('chat');
const input = document.getElementById('textInput');
const select = document.getElementById('conversationSelect');
const toggleBtn = document.getElementById('toggleBtn');

if (store.dark) document.body.classList.add("dark");

function save() {
  localStorage.setItem("chatStore", JSON.stringify(store));
}

function formatText(text) {
  if (!text) return "";

  return text
    .replace(/\*{1,2}(.*?)\*{1,2}/g, '<span class="gray">$1</span>')
    .replace(/\n/g, "<br>");
}

function renderConversations() {
  select.innerHTML = "";
  Object.keys(store.conversations).forEach(name => {
    const option = document.createElement("option");
    option.value = name;
    option.textContent = name;
    if (name === store.current) option.selected = true;
    select.appendChild(option);
  });
}

function renderMessages() {
  chat.innerHTML = "";
  store.conversations[store.current].forEach((msg, index) => {
    const message = document.createElement('div');
    message.className = 'message ' + msg.from;

    const bubble = document.createElement('div');
    bubble.className = 'bubble';

    const text = document.createElement('div');
    text.className = "text-content";
    text.innerHTML = formatText(msg.text);
    text.id = "text-" + index;

    const actions = document.createElement("div");
    actions.className = "action-row";

    const edit = document.createElement("span");
    edit.textContent = "Á∑®ÈõÜ";
    edit.onclick = () => startEdit(index);

    const del = document.createElement("span");
    del.textContent = "ÂâäÈô§";
    del.onclick = () => deleteMessage(index);

    actions.appendChild(edit);
    actions.appendChild(del);

    bubble.appendChild(text);
    bubble.appendChild(actions);
    message.appendChild(bubble);
    chat.appendChild(message);
  });
  chat.scrollTop = chat.scrollHeight;
}

function startEdit(index) {
  const textDiv = document.getElementById("text-" + index);
  const oldText = store.conversations[store.current][index].text;

  const textarea = document.createElement("textarea");
  textarea.className = "edit-input";
  textarea.value = oldText;

  autoResize(textarea);

  textarea.addEventListener("input", () => autoResize(textarea));

  textarea.addEventListener("keydown", (e) => {
    if ((e.ctrlKey || e.metaKey) && e.key === "Enter") {
      finishEdit(index, textarea.value);
    }
  });

  textarea.addEventListener("blur", () => {
    finishEdit(index, textarea.value);
  });

  textDiv.innerHTML = "";
  textDiv.appendChild(textarea);
  textarea.focus();
}

function autoResize(el) {
  el.style.height = "auto";
  el.style.height = el.scrollHeight + "px";
}

function finishEdit(index, newText) {
  if (!newText.trim()) return renderMessages();
  store.conversations[store.current][index].text = newText;
  save();
  renderMessages();
}

function sendMessage() {
  const text = input.value.trim();
  if (!text) return;

  store.conversations[store.current].push({
    from: currentSender,
    text: text
  });

  input.value = "";
  save();
  renderMessages();
}


function toggleSender() {
  currentSender = currentSender === "me" ? "other" : "me";
  toggleBtn.textContent = currentSender === "me" ? "Ëá™ÂàÜ" : "Áõ∏Êâã";
}

function renderConversations() {
  select.innerHTML = "";
  Object.keys(store.conversations).forEach(name => {
    const option = document.createElement("option");
    option.value = name;
    option.textContent = name;
    if (name === store.current) option.selected = true;
    select.appendChild(option);
  });
}

function deleteMessage(index) {
  store.conversations[store.current].splice(index, 1);
  save();
  renderMessages();
}

function createConversation() {
  const name = prompt("‰ºöË©±Âêç„ÇíÂÖ•Âäõ");
  if (!name) return;
  if (store.conversations[name]) return;
  store.conversations[name] = [];
  store.current = name;
  save();
  renderConversations();
  renderMessages();
}

function switchConversation() {
  store.current = select.value;
  save();
  renderMessages();
}

function toggleDarkMode() {
  document.body.classList.toggle("dark");
  store.dark = document.body.classList.contains("dark");
  save();
}

renderConversations();
renderMessages();
</script>

</body>
</html>
