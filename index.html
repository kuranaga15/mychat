<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>My Chat</title>

<style>
body {
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
  margin: 0;
  display: flex;
  flex-direction: column;
  height: 100vh;
  background: #f2f2f2;
  color: black;
  transition: 0.3s;
}

body.dark {
  background: #1e1e1e;
  color: white;
}

.header {
  padding: 10px;
  background: white;
  border-bottom: 1px solid #ddd;
  display: flex;
  gap: 8px;
}

body.dark .header {
  background: #2a2a2a;
  border-color: #444;
}

.chat {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
}

.message {
  margin: 15px 0;
  display: flex;
}

.me { justify-content: flex-end; }
.other { justify-content: flex-start; }

.bubble {
  padding: 10px 14px 6px 14px;
  border-radius: 16px;
  max-width: 70%;
  word-wrap: break-word;
  display: flex;
  flex-direction: column;
}

.me .bubble { background: #cfe9ff; }
.other .bubble { background: white; }

body.dark .me .bubble { background: #2f6ea3; }
body.dark .other .bubble { background: #333; }

.text-content {
  margin-bottom: 4px;
}

.action-row {
  font-size: 11px;
  color: #888;
  display: flex;
  gap: 10px;
}

.action-row span {
  cursor: pointer;
}

body.dark .action-row {
  color: #aaa;
}

.input-area {
  display: flex;
  padding: 10px;
  background: white;
  border-top: 1px solid #ddd;
  gap: 8px;
}

body.dark .input-area {
  background: #2a2a2a;
  border-color: #444;
}

input {
  flex: 1;
  padding: 10px;
  border-radius: 20px;
  border: 1px solid #ccc;
}

.edit-input {
  padding: 6px;
  border-radius: 8px;
  border: 1px solid #aaa;
  width: 100%;
}

button {
  padding: 8px 14px;
  border: none;
  border-radius: 20px;
  cursor: pointer;
}

#sendBtn { background: #4da3ff; color: white; }
#toggleBtn { background: #eee; }
</style>
</head>

<body>

<div class="header">
  <select id="conversationSelect" onchange="switchConversation()"></select>
  <button onclick="createConversation()">ï¼‹æ–°ã—ã„ä¼šè©±</button>
  <button onclick="toggleDarkMode()">ğŸŒ™</button>
</div>

<div class="chat" id="chat"></div>

<div class="input-area">
  <input type="text" id="textInput" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›">
  <button id="sendBtn" onclick="sendMessage()">é€ä¿¡</button>
  <button id="toggleBtn" onclick="toggleSender()">è‡ªåˆ†</button>
</div>

<script>
let store = JSON.parse(localStorage.getItem("chatStore")) || {
  conversations: { "default": [] },
  current: "default",
  dark: false
};

let currentSender = "me";

const chat = document.getElementById('chat');
const input = document.getElementById('textInput');
const select = document.getElementById('conversationSelect');
const toggleBtn = document.getElementById('toggleBtn');

if (store.dark) document.body.classList.add("dark");

function save() {
  localStorage.setItem("chatStore", JSON.stringify(store));
}

function renderConversations() {
  select.innerHTML = "";
  Object.keys(store.conversations).forEach(name => {
    const option = document.createElement("option");
    option.value = name;
    option.textContent = name;
    if (name === store.current) option.selected = true;
    select.appendChild(option);
  });
}

function renderMessages() {
  chat.innerHTML = "";
  store.conversations[store.current].forEach((msg, index) => {
    const message = document.createElement('div');
    message.className = 'message ' + msg.from;

    const bubble = document.createElement('div');
    bubble.className = 'bubble';

    const text = document.createElement('div');
    text.className = "text-content";
    text.textContent = msg.text;
    text.id = "text-" + index;

    const actions = document.createElement("div");
    actions.className = "action-row";

    const del = document.createElement("span");
    del.textContent = "å‰Šé™¤";
    del.onclick = () => deleteMessage(index);

    const edit = document.createElement("span");
    edit.textContent = "ç·¨é›†";
    edit.onclick = () => startEdit(index);

    actions.appendChild(edit);
    actions.appendChild(del);

    bubble.appendChild(text);
    bubble.appendChild(actions);
    message.appendChild(bubble);
    chat.appendChild(message);
  });
  chat.scrollTop = chat.scrollHeight;
}

function startEdit(index) {
  const textDiv = document.getElementById("text-" + index);
  const oldText = store.conversations[store.current][index].text;

  const inputEdit = document.createElement("input");
  inputEdit.className = "edit-input";
  inputEdit.value = oldText;

  inputEdit.onblur = () => finishEdit(index, inputEdit.value);
  inputEdit.onkeypress = (e) => {
    if (e.key === "Enter") {
      finishEdit(index, inputEdit.value);
    }
  };

  textDiv.innerHTML = "";
  textDiv.appendChild(inputEdit);
  inputEdit.focus();
}

function finishEdit(index, newText) {
  if (!newText.trim()) return renderMessages();
  store.conversations[store.current][index].text = newText;
  save();
  renderMessages();
}

function sendMessage() {
  const text = input.value.trim();
  if (!text) return;

  store.conversations[store.current].push({
    from: currentSender,
    text: text
  });

  input.value = "";
  save();
  renderMessages();
}

function toggleSender() {
  currentSender = currentSender === "me" ? "other" : "me";
  toggleBtn.textContent = currentSender === "me" ? "è‡ªåˆ†" : "ç›¸æ‰‹";
}

function deleteMessage(index) {
  store.conversations[store.current].splice(index, 1);
  save();
  renderMessages();
}

function createConversation() {
  const name = prompt("ä¼šè©±åã‚’å…¥åŠ›");
  if (!name) return;
  if (store.conversations[name]) return;
  store.conversations[name] = [];
  store.current = name;
  save();
  renderConversations();
  renderMessages();
}

function switchConversation() {
  store.current = select.value;
  save();
  renderMessages();
}

function toggleDarkMode() {
  document.body.classList.toggle("dark");
  store.dark = document.body.classList.contains("dark");
  save();
}

renderConversations();
renderMessages();
</script>

</body>
</html>
